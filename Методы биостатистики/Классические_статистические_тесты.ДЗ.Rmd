---
title: "Классические_статистические_тесты.ДЗ"
author: "Victoria Zaitceva"
date: "2024-11-25"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

Нулевая гипотеза: частота возникновения сердечно-сосудистых заболеваний не зависит от уровня физической активности у пациентов старше 50 лет, т.е. у людей с разными уровнями физ активностями в среднем будет одинаковая частота ссз.

Альтернативная гипотеза: частота возникновения сердечно-сосудистых заболеваний зависит от уровня физической активности у пациентов старше 50 лет.



## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("высокая", "низкая"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)


cardio <- ifelse(activity == "высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))


df100 <- data.frame(activity, cardio)

```

## Решение

Гипотеза двухсторонняя, так как мы изначально не делаем предположение о направлении взаимосвязи между переменными.

Уровень значимости α = 0.05 для двухстороннего теста.

```{r}

contingency_table100 <- table(df100$activity, df100$cardio)
contingency_table100

# Рассчитаем статистику Хи-квадрат
chisq_test100 <- chisq.test(contingency_table100)
chisq_test100

```

```{r}
alpha = 0.05

critical_value <- qchisq(1 - alpha, df = chisq_test100$parameter)

cat("Значение статистики", chisq_test100$statistic,
  "\nКритическое значение:", critical_value, "\n")
if (chisq_test100$statistic > critical_value) {
  cat("Отвергаем нулевую гипотезу")
} else {
  cat("Не можем отвергнуть нулевую гипотезу")
}

```



```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("высокая", "низкая"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))

df30 <- data.frame(activity, cardio)
    
```

Для малых выборок используем точный тест Фишера. 

```{r}
contingency_table30 <- table(df30$activity, df30$cardio)
contingency_table30 # есть <5 в ячейке

# Exact Fisher test

fisher_test <- fisher.test(contingency_table30)


cat("p-value:", fisher_test$p.value,
    "\nOdds Ratio:", fisher_test$estimate,
    "\nCI:", fisher_test$conf.int)
```
Т.к. 95% доверительный интервал содержит 1 (и p-value больше 0.05), мы не можем отвергнуть нулевую гипотезу.


Практическая значимость: если бы тест хи-квадрат или точный тест Фишера показали статистически значимые различия, мы могли бы посчитать тест Крамера для количественной оценки силы взаимосвязи между переменными и практического вывода. Однако, так как нам не удалось отвергнуть нулевую гипотезу, количественная оценка не имеет смысла.


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


Нулевая гипотеза: средний уровень систолического артериального давления не отличается у пациентов, получающих новый метод лечения, и у пациентов, получающих стандартное лечение.

Альтернативная гипотеза: средний уровень систолического артериального давления отличается у пациентов, получающих новый метод лечения, и у пациентов, получающих стандартное лечение.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean = 130, sd = 5)  # экспериментальная группа


# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 5)  # контрольная группа

```

## Решение

Для сравнение средних значений АД в двух независимыз выборках будем использовать t-test, так как мы сами установили дисперсию при генерации данных. На практике мы бы использовали метод Уэлча.

Так как мы знаем, что препарат снижает давление, то проведем односторонний тест.

Уровень значимости α = 0.05 для одностороннего теста.

```{r}
t_test <- t.test(group1, group2, alternative = "less", var.equal = TRUE)
```
p-value очень маленькое, что позволяет нам отвергнуть нулевую гипотезу, но можно еще отдельно посчитать критическое значение для т статистики (только для 0.95 квантиля т-распределения) и сравнить с ним.

```{r}
alpha = 0.05

df = 2 * sample_size - 2

critical_value <- qt(alpha, df = df)


cat("t-статистика:", t_test$statistic, 
    "\nКритическое значение:", critical_value, 
    "\np-value:", t_test$p.value, "\n")
if (t_test$statistic < critical_value) { # left-tailed test logic
  cat("Отвергаем нулевую гипотезу")
} else {
  cat("Не можем отвергнуть нулевую гипотезу")
}
```
Таким образом, мы можем отвергнуть нулевую гипотезу и сделать вывод о том, что новый метод лечения приводит к снижению среднего артериального давления.

Практическая значимость:

```{r}
cat("Применение нового ЛС в среднем снижает АД на", round(t_test$estimate[2] - t_test$estimate[1], 1), "мм.рт.ст")
```


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

Нулевая гипотеза: средний уровень физической активности не отличается до и после реабилитации.
Альтернативная гипотеза: средний уровень физической активности улучшается после реабилитации.

## Генерация данных 

rnorm - т.к. мы моделируем среднее значение по шкале от 1 до 100, а не бинарную переменную

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rnorm(sample_size, 50, 5)

# Генерация данных после реабилитации
after <- rnorm(sample_size, 60, 5)  

```

## Решение

t test or wilcoxon test

Сравниваем до и после - выборки связанные, поэтому используем wilcoxon-test для связанных выборок.
Правосторонний тест, так как мы знаем, что после реабилитации физическая активность улучшается (увеличивается). wilcoxon тест возможно будет лучше, так как данные - шкала от 1 до 100, и могут быть не нормально распределены.

Уровень значимости α = 0.05 для одностороннего теста.

```{r}
wilcox_test <- wilcox.test(before, after, alternative = "greater", paired = TRUE)
wilcox_test
```
p-value = 1 не позволяет нам отвергнуть нулевую гипотезу, поэтому средний уровень физической активности не отличается до и после реабилитации.



# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

Нулевая гипотеза: доля пациентов, вернувшихся к нормальной физической активности, не отличается у пациентов, получающих новый метод лечения, и у пациентов, получающих стандартное лечение.

Альтернативная гипотеза: доля пациентов, вернувшихся к нормальной физической активности, отличается у пациентов, получающих новый метод лечения, и у пациентов, получающих стандартное лечение.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- sample(c("новый метод", "стандарт"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(treatment == "новый метод", 
                   rbinom(sample_size, 1, 0.7), 
                   rbinom(sample_size, 1, 0.65))

df <- data.frame(treatment, activity)
    
    
```

## Решение

Для сравнения распределения долей пациентов, вернувшихся к нормальной физической активности, между группами будем использовать Z-критерий для разности долей для независимых выборок выборок.

Правосторонний тест, так как мы знаем, что после нового метода лечения физическая активность улучшается (увеличивается).

```{r}

n1 <- sum(df$treatment == "новый метод")  # Размер группы нового метода
x1 <- sum(df$treatment == "новый метод" & df$activity == 1)  # Вернулись к активности (новый метод)
n2 <- sum(df$treatment == "стандарт")  # Размер группы стандарта
x2 <- sum(df$treatment == "стандарт" & df$activity == 1)  # Вернулись к активности (стандарт)

# Пропорции
p1 <- x1 / n1
p2 <- x2 / n2

# p - объединенная доля
p = (p1 * n1 + p2 * n2) / (n1 + n2)


z_stat = (p1 - p2) / sqrt(p * (1 - p) * (1/n1 + 1/n2)) # ~ N(0, 1)

z_critical <- qnorm(1 - alpha)  

p_value <- 1 - pnorm(z_stat)


cat("p-value:", p_value,
    "\nZ-статистика:", z_stat,
    "\nКритическое значение:", z_critical)
if (p_value < alpha) {
  cat("\nОтвергаем нулевую гипотезу")
} else {
  cat("\nНе можем отвергнуть нулевую гипотезу")
}

```
Практическая значимость: новый метод лечения увеличивает нормализацию физической активности.

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

Нулевая гипотеза: медитация не влияет на наличие стресса у лиц с высоким уровнем тревожности.
Альтернативная гипотеза: медитация влияет на наличие стресса у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- sample(c(0, 1), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- ifelse(before == 0, 
                rbinom(sample_size, 1, 0.2), 
                rbinom(sample_size, 1, 0.4))



df <- data.frame(before, after)

```

## Решение

Так как изучается воздействие на одну и ту же группу и да/есть исход, мы имеем дело с парными бинарными данными и поэтому используем McNemar's test.

Так как мы не знаем, в какую сторону изменится стресс после медитации, используем двусторонний тест.

Уровень значимости α = 0.05 для двухстороннего теста.

```{r}
contingency_table <- table(df$before, df$after)
mcnemar_test <- mcnemar.test(contingency_table)


if (mcnemar_test$p.value < alpha) {
  cat("Отвергаем нулевую гипотезу")
} else {
  cat("Не можем отвергнуть нулевую гипотезу")
}
```
Таким образом, мы можем отвергнуть нулевую гипотезу и сделать вывод о том, что медитация влияет на наличие стресса у лиц с высоким уровнем тревожности.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

Нулевая гипотеза: средний уровень депрессии не отличается у пациентов, получающих альтернативный метод лечения, и у пациентов, получающих стандартное лечение.

Альтернативная гипотеза: средний уровень депрессии отличается у пациентов, получающих альтернативный метод лечения, и у пациентов, получающих стандартное лечение.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rnorm(sample_size, mean = 55, sd = 5)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 68, sd = 5)  # контрольная группа


df = data.frame(group1, group2)

```

## Решение

Так как данные - баллы по шкале от 1 до 100, и могут быть не нормально распределены,а также размер выборки небольшой, используем непараметрический тест Уилкоксона для несвязанных выборок.

Делаем двухсторонний тест, так как нет предположений о направлении эффекта.

Уровень значимости α = 0.05 для двухстороннего теста.

```{r}
wilcox_test <- wilcox.test(df$group1, df$group2, alternative = "two.sided")
wilcox_test

if (wilcox_test$p.value < alpha) {
  cat("Отвергаем нулевую гипотезу")
} else {
  cat("Не можем отвергнуть нулевую гипотезу")
}
```
Таким образом, средний уровень депрессии отличается у пациентов, получающих альтернативный метод лечения, и у пациентов, получающих стандартное лечение, различается.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

Нулевая гипотеза: длительность сна не ассоциирована с уровнем стресса у студентов.

Альтернативная гипотеза: длительность сна ассоциирована с уровнем стресса у студентов.

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

Так как мы исследуем ассоциацию терапии с количественной переменной, используем корреляционный анализ. Размер выборки большой. Используем корреляцию Пирсона.

```{r}

cor_test <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
cor_test
```

Результат теста показывает, что уровень стресса у студентов ассоциирован с длительностью сна (p-value < 0.05). 95% доверительный интервал не содержит 0, что также говорит о наличии ассоциации.

```{r}
ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue", se = TRUE) +
  theme_bw() +
  labs(title = "Ассоциация между длительностью сна и уровнем стресса у студентов",
       x = "Длительность сна, ч",
       y = "Уровень стресса")
```
Практическая значимость: студенты, которые спят дольше, имеют более низкий уровень стресса. 








