---
title: "Bivariate_hypothesis_testing_2"
author: "Oleg Arnaut"
date: "2024-10-24"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

#install.packages('BSDA')

library(tidyverse)
library(BSDA)
```





# lecture 2 start 

## Разница дисперсий 

H0: дисперсии в группах равны
H1: дисперсии не равны



### Тест Фишера (F-test) для отношения дисперсий vs t-test 

Предположим, мы проводим исследование, в котором измерям уровень тиреоидных гормонов в контрольной и экспериментальной группе. 

Нас интересует, есть ли разница в дисперсиях этих измерений между группами.

Например потому что на основании сравнения средних значений мы не можем отвергнуть нулевую гипотезу о равенстве средних, но при этом дисперсии могут быть разными - то есть в группах могут быть разные разбросы значений - и это может быть важно.


```{r}

# Наборы данных для группы A и группы B
group_A <- c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
group_B <- c(10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30)

#?var.test

# Выполнение F-теста на отношения дисперсий
результат_F_теста <- var.test(group_A, group_B)

# Вывод результатов F-теста 
cat("Результат F-теста (отношения дисперсий):\n")
print(результат_F_теста)

# Выполнение двухвыборочного t-теста для средних значений двух независимых выборок (предполагается неравенство дисперсий)
результат_t_теста <- t.test(group_A, group_B, var.equal = FALSE) #var.equal = FALSE - метод Уэлча

# Вывод результатов t-теста
cat("\nРезультат t-теста (равенство средних):\n")
print(результат_t_теста)


```

На основании t-теста мы не можем отвергнуть нулевую гипотезу (p = 1) - средние в группе  одинаковые. 

Однако, на основании F-теста мы можем отвергнуть нулевую гипотезу о равенстве дисперсий в группах (p = 0.05).

Теперь визуализируем результаты F-теста.

```{r}

observed_f_value <- результат_F_теста$statistic  # реальное наблюдаемое значение F-статистики

# Определение параметров степеней свободы для F-распределения

df1 <-length(group_A) - 1   # Степени свободы числителя - 11-1
df2 <- length(group_B) - 1  # Степени свободы знаменателя

# Создание последовательности значений x
x_values <- seq(0.01, 5, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Тест Фишера - точный, используем F-распределение

# Расчет значений PDF для F-распределения
pdf_fisher <- df(x_values, df1, df2)

# Определение уровня значимости (альфа) для критических значений
quantiles <- c(0.05, 1)  # тест может быть как двухсторонним, так и односторонним 

# Расчет критических значений для F-распределения
# qf - квантиль F-распределения
critical_value_lower <- qf(quantiles[1], df1, df2)
critical_value_upper <- qf(quantiles[2], df1, df2)

# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_fisher)

# Создание графика PDF для визуализации F-распределения
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF F-распределения Фишера-Снедекора", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_f_value),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             linewidth = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_f_value-0.15, y = 0.2, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = 4, y = 0.6, label = sprintf("df1=%.0f, df2=%.0f", df1, df2), hjust = 0)

```
Можем отвергнуть нулевую гипотезу о равенстве дисперсий в группах, так как наблюдаемое значение F-статистики (красная пунктирная линия) превышает критическое значение F-статистики (синие линии) при уровне значимости 0.05.

# Непараметрические тесты

## Тест Манна-Уитни-Уилкоксона (вероятностное доминирование)

```{r mw_1}

#?wilcox.test()

n <- 30 # 30 наблюдений в каждой группе

# Среднии значения в группах

t1 <- 1 # Средняя продолжительность болезни в группе 1
t2 <- 1 # Средняя продолжительность болезни в группе 2

# генерируем случайные выборки из экспоненциального распределения со средними значениями t1 и t2
sample_1 <- sort( round(rexp(n, 1/t1),2) )
sample_2 <- sort( round(rexp(n, 1/t2),2) )

df1 <- data.frame(n1 = 1:n,
                  d1  = sort(sample_1)) 

df2 <- data.frame(n2 = 1:n,
                  d2  = sort(sample_2))

df <- merge(df1, df2) %>% 
  mutate(rez = case_when(
    # сравниваем 2 группы
    d1 > d2 ~ +1, 
    d1 < d2 ~ -1,
    TRUE ~ 0)) %>% 
  dplyr::select(-c("d1", "d2")) %>% 
  pivot_wider(names_from = n2, values_from = rez) %>% 
  tibble::column_to_rownames('n1')

#визуализируем результаты теста Манна-Уитни-Уилкоксона
#всего квадратиков 30 на 30

# красный квадрат - победа группы 1
# синий квадрат - победа группы 2
# желтые - равные значения

# ось У - значения в группе 1
# ось Х - значения в группе 2

pheatmap::pheatmap(df,
                   cluster_cols = FALSE,
                   cluster_rows = FALSE)

```


## Критерий Chi squared


Н0: распределение признака в популяции соответствует гипотетическому (ожидаемые и наблюдаемые частоты совпадают) - нет статистически значимой ассоциации между признаками

Н1: распределение признака в популяции не соответствует гипотетическому (ожидаемые и наблюдаемые частоты различаются) - есть статистически значимая ассоциация между признаками

```{r}

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- 5.9  # Замените на ваше реальное наблюдаемое значение

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 10, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили - критические значения - правосторонний тест
quantiles <- c(0, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df) # 0 quantile
critical_value_upper <- qchisq(quantiles[2], df) # 95



# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_chi_squared - 0.5, y = 0.1, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 0.5, label = sprintf("df = %.0f", df), hjust = 0)


```

Посчитанные критические значения для хи-квадрат распределения (0,95 квантили - синии линии) и наблюдаемое значение хи-квадрат статистики, посчитанные по реальным данным (красная пунктирная линия) визуализированы на графике.

Отвергаем нулевую гипотезу, так как наблюдаемое значение хи-квадрат статистики превышает критическое значение хи-квадрат статистики при уровне значимости 0.05.


```{r}

# Создание таблицы сопряженности (замените своими данными)
m <- matrix(c(100, 80, 200, 100), nrow = 2)
rownames(m) <- c("Группа A", "Группа В")
colnames(m) <- c("Болен", "Здоров")

print(m)

# Проведение теста хи-квадрат для ассоциации
chi_result <- chisq.test(m)

# Извлечение стандартизированных остатков
residuals <- chi_result$residuals

cat("\nСтандартизированные остатки:\n")
print(residuals)


```

## chisq.test Monte Carlo

Our sample

```{r}


x <- matrix(c(5, 1, 1, 4), ncol=2)
rownames(x) <- c("Group A", "Group B")
colnames(x) <- c("Outcome 1", "Outcome 2")

# тест хи-квадрат
print(chisq.test(x))   



```


В случае если есть ячейки с ожидаемым значением <1 и более 20% ячеек с значениями <5 можно использовать метод Монте-Карло

Такие ячейки могут быть проблемой для точности теста хи-квадрат.


```{r}

# тест хи-квадрат
print(chisq.test(x, simulate.p.value = TRUE, B = 10000)) # 10000 simulations

```

## chisq.test() goodness of fit (критерий соответствия), Хи-квадрат критерий согласия 


Одинаково для распространены разные виды осложнения среди пациентов после операции?

8 инфекционных, 12 кровотечений, 10 осложнений с дыханием, 9 осложнений с сердцем, 16 другие

H0: Распределение частоты осложнений одинаково
H1: Распределение частоты осложнений различно

```{r}

# Наблюдаемые частоты
observed <- c(8, 12, 10, 9, 16)

# 55 всего наблюдений - 5 типов осложнений - тогда в каждой клеточке ожидаемое значение 11

# Проведение теста хи-квадрат - 
chi <- chisq.test(observed, p = c(0.2, 0.2, 0.2, 0.2, 0.2))

# Вывод результатов
print(chi)

# Интерпретация результатов
alpha <- 0.05
if (chi$p.value < alpha) {
  cat("Отклонить нулевую гипотезу\n")
} else {
  cat("Не удалось отклонить нулевую гипотезу\n")
}

chi$residuals


```
Визуализируем

```{r}
# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- chi$statistic  # из предыдущего чанка

df <- 5 - 1   # тоже из предыдущего чанка

# Создание последовательности значений x
x_values <- seq(0.01, 10, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили - критические значения - правосторонний тест
quantiles <- c(0, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df) # 0 quantile
critical_value_upper <- qchisq(quantiles[2], df) # 95



# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_chi_squared - 0.5, y = 0.1, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 0.5, label = sprintf("df = %.0f", df), hjust = 0)
```

Наблюдаемое значение хи-квадрат статистики (красная пунктирная линия) попадает внутрь критических значений хи-квадрат статистики (синие линии) при уровне значимости 0.05, что означает, что мы не можем отклонить нулевую гипотезу о равенстве частот осложнений.


# Повторные измерения для таблиц сопряжённости (Тест Мак-Немара)

**Выборки зависимы:** одни и те же объекты измеряются дважды (до и после воздействия)

H0: Вероятность события до воздействия равна вероятности события после воздействия
H0: Вероятность события до воздействия не равна вероятности события после воздействия

Похож на Chi squared !!!

```{r}


#?mcnemar.test

# Пример данных с двумя категориальными переменными (до и после воздействия)

my_matrix <- matrix(c(9, 1, 1, 9), 
             nrow = 2, ncol = 2, 
             dimnames = list("До" = c("Инфильтрация +", "Инфильтрация -"), 
                             "После" = c("Инфильтрация +", "Инфильтрация -")))

# нас интересуют только диагональные элементы - те, которые поменялись
print(my_matrix)

# Chi squared test - его не надо делать для зависимых выборок! хотя в этом случае он дает значимый результат
print(chisq.test(my_matrix, simulate.p.value = TRUE, B = 10000))

# McNemar's test
print(mcnemar.test(my_matrix))


```




