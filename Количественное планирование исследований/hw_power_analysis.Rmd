---
title: "ДЗ по количественному планированию исследований"
author: "Victoria Zaitceva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(reprex)
```

## Задание 1

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите.
Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3
месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей
эффективности – 2 %.



### Решение:

Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим образом:

H0: T – R ≤ δ 
HA: T – R \> δ

Где Т - абсолютный прирост индекса за 3 месяца в среднем для препарата исследуемого препарата T, 
R - абсолютный прирост индекса за 3 месяца в контрольной группе,
δ - граница не меньшей эффективности (2%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Распределение в группы будет равномерным в соотношении 1:1;

2. Односторонняя величина ошибки I рода (α) составляет 0.025;

3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;

4. На основании литературных данных мы ожидаем величину эффекта в группе
исследуемого препарата в среднем (M±SD) составлял 7.2 ± 3.1%. Предполагаемый результат в контрольной группе - такой же;

5. Граница превосходства препарата по сравнению с активным контролем равна -2%.

Расчёт размера выборки был проведён в RStudio** (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.0) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.

```{r}

TwoSampleMean.NIS(
  alpha = 0.025,
  beta = 0.2,
  sigma = 3.1,
  k = 1,
  delta = 0,
  margin = -2
)
```
Таким образом, в каждую группу необходимо включить не менее 38 обследуемых, всего – 38*2 = 76 пациента.

С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в каждую группу
необходимо набрать не менее 38*1.2 = 46 обследуемых. В скрининг (с учётом 10% выбывания) необходимо
включить не менее 46*1.1 = 51 обследуемых в каждую группу. Итого -  102 пацинта. 



## Задание 2

Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.


### Решение:

Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом: 

H0: T – R \<= δ 
HA: T – R \> δ 

Где T – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения в группе исследуемого препрата; 
R – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения; 
δ – граница превосходства (1%).


При расчёте необходимого размера выборки были сделаны следующие допущения:


1. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%;

2. Граница превосходства: 1%;

3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;

4. В группу T должно быть рандомизировано в 2 раза больше пациентов, чем в группу R;

5. Односторонняя величина ошибки I рода (α) составляет 0.025;

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.0) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.


```{r}
#?TwoSampleProportion.NIS
TwoSampleProportion.NIS(
  alpha = 0.025,
  beta = 0.2,
  p1 = 0.81,
  p2 = 0.66,
  k = 2,
  delta = 0.15,
  margin = 0.01
)

```

242 пациента в группу с исследуемым препаратом и 121 пациент в контрольную группу, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:

```{r}
ceiling(242*1.2*1.1)
ceiling(121*1.2*1.1)
```

Итого: суммарно 480 пациентов (320 - исследуемая, 160 - контроль).




## Задание 3

Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.

### Решение

Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:

H0: T – R \>= δ 
HA: T – R \< δ

При расчёте необходимого размера выборки были сделаны следующие допущения: 

1. Распределение в группы будет в соотношении 3:4 (75% в группе А); 

2. Односторонняя величина ошибки I рода (α) составляет 0.025; 

3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; 

4. Из литературных данных известно, что для препарата Б средний объём кровопотери 306 ± 52 мл. Для исследуемого препарата А средний объём кровопотери 241.6 мл (стандартное отклонение не известно, поэтому считается равным отклонению препарата Б);

5. Граница превосходства о сравнению с контролем равна -50 мл.

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.0) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее. 

```{r}
TwoSampleMean.NIS(
  alpha = 0.025,
  beta = 0.2,
  sigma = 52,
  k = 0.75,
  margin = -50,
  delta = 241.6 - 306
)
```
180 пациента в группу с исследуемым препаратом и 180/0.75 = 240 пациент в группу с контролем, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:

```{r}
ceiling((240)*1.2*1.1)
```

Итого: суммарно 238+317=555 пациентов (238 - исследуемая, 317 - контроль).



## Задание 4

Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%.
При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования.



### Решение

Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом: 

H0: T – R \>= δ 
HA: T – R \< δ 

Где T – доля рецидивов псориатического артрита (за 6 месяцев) в группе исследуемого препрата Y; 
R – доля рецидивов псориатического артрита (за 6 месяцев) в группе котрольного препарата X; 
δ – граница превосходства (-5%).

При расчёте необходимого размера выборки были сделаны следующие допущения: 


1. Исследование ограничено тем, что у спонсора в наличии 250 пачек препарата X (контрольного препарата). Кол-во пачек исследуемого препарата неограниченно. 

2. Односторонняя величина ошибки I рода (α) составляет 0.025; 

3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2; 

4. Из литературных данных известно, что для препарата X доля рецидивов - 32%. Для исследуемого препарата Y доля рецидивов предполагается равной 17%. 

5. Граница превосходства о сравнению с контролем равна -5%.

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.0) с помощью функции epi.sssupb пакета EpiR (версия 2.0.77).

Результаты расчёта представлены далее. 


```{r}
r <- 0.1
result <- NA  

# Iterate to find the smallest k where the control sample size is < 250
repeat {

result <- epi.sssupb(
    treat = 0.32,
    control = 0.17,
    delta = 0.05,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = r
)
  if (result$n.control < 250) {
      break
  }
  r <- r + 0.1
}

cat("Оптимальное соотношение групп:", r, "\n")
cat("Исследуемая группа:", result$n.treat, "\n", 
    "Контроль:", result$n.control, "\n")

```

316 пациента в группу с исследуемым препаратом и 243 пациент в группу с контролем, с учётов 20% потери в ходе исследования и 10% потери пациентов на стадии скрининга получаем:

```{r}
ceiling((316)*1.3)
ceiling((243)*1.3)
```

Итого: суммарно 411+316=727 пациентов (411 - исследуемая, 316 - контроль).
