---
title: "Sample_size_calc"
author: "Glazkov A.A."
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(reprex)

```

# Расчёт размера выборки в КИ (количественные конечные точки)

## Гипотеза превосходства

Предыстория: в пилотном исследовании было показано, что некий препарат позволяет
классно снижать массу тела у пациентов. Масса тела за 3 месяца диеты в сочетании 
с препаратом снизилась на 12±5 %. 

Задача: провести клиническое исследование III фазы и продемонстрировать 
эффективность препарата в сравнении с плацебо

Конечная точка: Снижение массы тела за 3 месяца в % от исходного уровня

Из данных литературы известно, что на диете масса тела снижается на 5±5 %.

Клинически значимая разница - разница в 5%

Гипотеза превосходства является односторонней, поэтому в исследовании будет
использован уровень альфа 0.025, уровень мощности - 80%

```{r}

# Проведём расчёт

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 5,
    k = 1,
    delta = 7,       # это разница между группами!
    margin = 5       # это граница превосходства!
)


```

Обрадуемся высокой информативности полученной выдачи и попробуем перепроверить 
расчёт в другом пакете.

```{r}

?epi.sssupc

epi.sssupc(
    treat = 12,
    control = 5,
    sigma = 5,
    delta = 5,      # это граница превосходства!
    n = NA,
    r = 1,
    alpha = 0.025,
    power = 0.8
)



```

В каждую группу необходимо включить не менее 99 пациентов.

## Гипотеза не меньшей эффективности

Предыстория: существует препарат X, который снижает ВАШ (в мм) оценки болезненности суставов при ходьбе у пациентов с ревматоидным артритом на 10.7 ± 8.2 мм.

Задача: доказать, что предлагаемый нами препарат Y обладает не меньшей эффективностью в сравнении с препаратом X

Конечная точка: Снижение ВАШ (в мм) болезненности суставов при ходьбе

Клинически значимая разница - разница в 5 мм

```{r}

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 8.2,
    k = 1,
    delta = 0,
    margin = -5
)

```



```{r}

epi.ssninfc(
    treat = 10.7,
    control = 10.7,
    delta = 5,
    sigma = 8.2,
    r = 1,
    n = NA,
    alpha = 0.025,
    power = 0.8
)


```

## Шиворот-навыворот

Предыстория: по данным обзора [Иванов И.И. и др., 2022] у пациентов с рассеянным 
склерозом на фоне приёма препарата R за 1 год наблюдения развивается в среднем 
14.4 ± 5.4 новых очагов.

Предыстория 2: разработан препарат T, который в предварительных исследованиях 
показал, что у пациентов за 1 год наблюдения развивается 11.3 ± 4.2 новых очагов.

Задача: доказать, что предлагаемый нами препарат T превосходит препарат R в контроле рассеянного склероза.

Конечная точка: Количество новых очагов за период наблюдения.

Клинически значимая разница - разница в 2 очага.
Спонсор хочет, чтобы в тестовую группу вошло в 2 раза больше пациентов, чем в группу референтного препарата.

```{r}

sqrt((2*4.2^2 + 5.4^2) / 3)
11.3 - 14.4

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    k = 2,
    sigma = 4.6, 
    delta = -3.1,
    margin = -2
)



```


```{r}

epi.sssupc(
    treat = 14.4,
    control = 11.3,
    sigma = 4.6,
    delta = 2,
    alpha = 0.025,
    power = 0.8,
    n = NA,
    r = 0.5
)

```


# Расчёт размера выборки в КИ (качественные конечные точки)

## Функция, моделирующая серию экспериментов и считающая как часто отвергается H0 для критерия Хи-квадрат

```{r}

# n - количество наблюдений в одной группе
# ex_n - количество серий экспериментов
# p1, p2 - доли в двух группах

series_H0_rej <- function(n, ex_n, p1, p2){
    
    tibble(x1 = rbinom(ex_n, n, p1),
           x2 = rbinom(ex_n, n, p2)) %>% 
        rowwise() %>% 
        mutate(p = chisq.test(matrix(c(x1, n-x1, x2, n-x2), 
                                     nrow = 2),
                              correct = F,
                              )$p.value < 0.05) %>% 
        ungroup() %>% 
        pull(p) %>% 
        sum(na.rm = T) / ex_n
 
}




```

### Проверим, как ведёт себя ошибка I рода

```{r, fig.height=3, fig.width=6, dpi=100}

tibble(N = rep(seq(50, 250, 50), each = 19),
       p1 = rep(seq(0.05, 0.95, 0.05), times = 5),
       p2 = p1) %>% 
    rowwise() %>% 
    mutate(H0_rej = series_H0_rej(N, 1000, p1, p2)) %>% 
    ungroup() %>% 
    mutate(N = N %>% as.factor()) %>% 
    ggplot(aes(x = p1, y = H0_rej, group = N, color = N)) +
    geom_line() + 
    scale_y_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1)) + 
    scale_x_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1)) +
    labs(x = "Proportion",
         y = "H0 rejected") +
    theme_bw()
    

```


### Проверим, как ведёт себя ошибка II рода на разнице в 0.1

```{r, fig.height=3, fig.width=6, dpi=100}

tibble(N = rep(seq(50, 250, 50), each = 19),
       p1 = rep(seq(0.0, 0.9, 0.05), 5),
       p2 = p1+0.1) %>% 
    rowwise() %>% 
    mutate(H0_rej = series_H0_rej(N, 1000, p1, p2)) %>% 
    ungroup() %>% 
    mutate(N = N %>% as.factor()) %>% 
    ggplot(aes(x = p1, y = H0_rej, group = N, color = N)) +
    geom_line() + 
    scale_y_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1)) + 
    scale_x_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1)) +
    labs(x = "Proportion",
         y = "H0 rejected") +
    theme_bw()
    

```

### Покажем, почему лучше выбирать количественную ПКТ

Спланируем исследование для поиска вот таких различий:
M1 = 20, M2 = 23, SD1 = SD2 = 5

```{r}

power.t.test(delta = 3, sd = 5, sig.level = 0.05, power = 0.8)

```

Надо набрать по 45 пациентов в группу

```{r}

n <- 45
m1 <- 20
m2 <- 23
sd1 <- sd2 <- 5

lapply(1:1000, function(i){
    
    sample1 <- rnorm(n, m1, sd1) # Генерируем выборку 1
    sample2 <- rnorm(n, m2, sd2) # Генерируем выборку 2
    
    t_test_res <- t.test(sample1, sample2) # Проводим t-test
    
    x1 <- (sample1 > ((m1 + m2 ) / 2)) %>% sum()
    x2 <- (sample2 > ((m1 + m2 ) / 2)) %>% sum()
    
    chi_test_res <- chisq.test(
        matrix(
            c(x1, n-x1, x2, n-x2),
            nrow = 2
        ),
        correct = F
    )
    
    tibble(p_t = t_test_res$p.value,                               
           H0_rejected_t = ifelse(p_t < 0.05, 1, 0),
           p1 = x1 / n,
           p2 = x2 / n,
           p_chi = chi_test_res$p.value,
           H0_rejected_chi = ifelse(p_chi < 0.05, 1, 0)) 
}) %>% bind_rows() -> series_results

series_results %>% head()

# Сколько раз отвергли H0 для t-test'a

series_results$H0_rejected_t %>% sum()

# Сколько раз отвергли H0 для критерия Хи-квадрат

series_results$H0_rejected_chi %>% sum()

```

## Расчёт размера выборки для качественной конечной точки

Исследование превосходства препарата А над препаратом Б.
Критерий эффективности - сохранение ответа на терапию в течение 6+ месяцев.
Из предыдущих исследований известно, что препарат Б даёт стойкую ремиссию в 
32-41 % случаев (в зависимости от исследования).
Клинически значимая разница - прирост в 5%.
Ожидаемый прирост эффективности препарата А по отношению к препарату Б - 15%.

```{r}

TwoSampleProportion.NIS(
    alpha = 0.025,
    beta = 0.2,
    p1 = 0.41,
    p2 = 0.56,
    delta = 0.15,
    margin = 0.05,
    k = 1
)

```

```{r}

epi.sssupb(
    treat = 0.56,
    control = 0.41,
    delta = 0.05,
    alpha = 0.025,
    power = 0.8,
    r = 1,
    n = NA
)

```


# Анализ результатов исследований превосходства / не меньшей эффективности

## Количественная конечная точка

```{r}

# R умеет делать t-test для H0 гипотез превосходства и не меньшей эффективности!

# Это пример, как нельзя вызывать функцию для расчёта размера выборки
# потому что её очень сложно читать

TwoSampleMean.NIS(
    0.025,
    0.1,
    5,
    1,
    0,
    -2
)

sample_T <- rnorm(132, 20, 5)
sample_R <- rnorm(132, 20, 5) 

t.test(sample_T, sample_R)

?t.test()

t.test(
    sample_T,
    sample_R,
    alternative = "greater",
    mu = -2,
    conf.level = 0.975
)

```


## Качественная конечная точка

```{r}

BinomDiffCI(0, 10, 0, 10)

```


# Тренируемся

## 1.	

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении эпилепсии. Первичная конечная точка – доля пациентов в группе, которые достигли ремиссии за 12 месяцев терапии. Ожидаемая частота достижения ремиссии для препарата R, согласно литературным данным, составляет 64%.
Границу не меньшей эффективности предлагается установить равной 15%.

```{r}



```


## 2.	

Исследование превосходства препарата T над плацебо в лечении бессонницы. 
Спонсор желает доказать, что в сравнении с плацебо применение препарата позволяет сократить длительность засыпания на 15 минут или более. Согласно данным пилотных исследований, препарат Т в среднем сокращал длительность засыпания на 28 ± 11 минут. При этом из данных другого исследования известно, что плацебо сокращает длительность засыпания на 10 ± 7 минут.

```{r}



```


## 3.	

Исследование превосходства препарата T над референтным лечением R в лечении рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

```{r}



```


## 4.	

Исследование превосходства препарата T над гомеопатическим препаратом R в лечении простудных заболеваний. Первичная конечная точка – длительность наличия симптомов ОРВИ в днях (с момента начала приёма препарата*). Из литературных данных известно, что на фоне лечения препаратом R средняя длительность болезни составляет 13,2 ± 2,1 дней. Ожидается, что длительность болезни на фоне тестового препарата будет составлять 11 ± 2 дней. Границу превосходства предполагается установить равной 1 дню.

* приём препарата начинается не позже 2 дня с момента развития симптомов заболевания

```{r}



```


## 5.	

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении болей в коленном суставе. Первичная конечная точка – среднее снижение боли по шкале ВАШ (в мм) к 21 дню терапии по сравнению со значениями на скрининге. Из литературных данных известно, что среднее снижение боли для препарата R за 21 день терапии составляет 12 ± 7 мм. Граница не меньшей эффективности – 5 мм.

```{r}



```

