---
title: "Sample_size_calc"
author: "Glazkov A.A."
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(rpact)

set.seed(42)

```

# Тренируемся

## 1.	

Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении эпилепсии. Первичная конечная точка – доля пациентов в группе, которые достигли ремиссии за 12 месяцев терапии. Ожидаемая частота достижения ремиссии для препарата R, согласно литературным данным, составляет 64%.
Границу не меньшей эффективности предлагается установить равной 15%.

H0: T-R <= d
Ha: T-R > d

d = -15%

```{r}

?TwoSampleProportion.NIS

TwoSampleProportion.NIS(
    alpha = 0.025,
    beta = 0.2,
    p1 = 0.64,
    p2 = 0.64,
    k = 1,
    delta = 0,
    margin = -0.15
)

```
161 пациент в каждую группу

##################################

H0: T-R <= -d
Ha: T-R > -d

d = 15%

```{r}

?epi.ssninfb()

epi.ssninfb(
    treat = 0.64,
    control = 0.64,
    delta = 0.15,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 1
)

```


## 2.	

Исследование превосходства препарата T над плацебо в лечении бессонницы. 
Спонсор желает доказать, что в сравнении с плацебо применение препарата позволяет сократить длительность засыпания на 15 минут или более. Согласно данным пилотных исследований, препарат Т в среднем сокращал длительность засыпания на 28 ± 11 минут. При этом из данных другого исследования известно, что плацебо сокращает длительность засыпания на 10 ± 7 минут.

H0: mT - mP <= d
Ha: mT - mP > d

mT = sum(X1 - X2) / n

d = 15

```{r}

?TwoSampleMean.NIS

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 9,
    k = 1,
    delta = 15,
    margin = 18
)

```
```{r}

epi.sssupc(
    treat = 28,
    control = 10,
    sigma = 9,
    delta = 15,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 1    
)

```




## 3.	

Исследование превосходства препарата T над гомеопатическим препаратом R в лечении простудных заболеваний. Первичная конечная точка – длительность наличия симптомов ОРВИ в днях (с момента начала приёма препарата*). Из литературных данных известно, что на фоне лечения препаратом R средняя длительность болезни составляет 13,2 ± 2,1 дней. Ожидается, что длительность болезни на фоне тестового препарата будет составлять 11 ± 2 дней. Границу превосходства предполагается установить равной 1 дню.

* приём препарата начинается не позже 2 дня с момента развития симптомов заболевания

H0: T-R >= d
Ha: T-R < d
Ha: R-T > d

d = -1

```{r}

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 2.05,
    k = 1,
    delta = -1,
    margin = -2.2
)

```

```{r}

epi.sssupc(
    treat = 13.2,
    control = 11,
    sigma = 2.05,
    delta = 1,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 1,
    nfractional = T
)

```



# Адаптивный дизайн исследования

## Функция, которая моделирует 2 последовательных эксперимента по n наблюдений

```{r}

two_experiments <- function(n, 
                            m1, sd1, 
                            m2, sd2,
                            delta,
                            a1, 
                            a2){
    
    sample1 <- rnorm(n, m1, sd1) # Генерируем выборку 1
    sample2 <- rnorm(n, m2, sd2) # Генерируем выборку 2
    
    test_res_1 <- t.test(sample1, 
                         sample2,
                         alternative = c("greater"),
                         conf.level = 1 - a1,
                         mu = delta) # Проводим первый t-test на уровне значимости a1
    
    # Результаты первого теста
    
    p1 <- test_res_1$p.value
    H0_rejected_1 = ifelse(p1 < a1, 1, 0)
    
    # Если в первом тесте не отвергли H0, "добираем" выборку
    # и делаем второй тест
    
    if (H0_rejected_1 == 0){
        sample1.2 <- c(sample1,
                       rnorm(n, m1, sd1))
        sample2.2 <- c(sample2,
                       rnorm(n, m2, sd2))
        
        test_res_2 <- t.test(sample1.2, 
                             sample2.2,
                             alternative = c("greater"),
                             conf.level = 1 - a2,
                             mu = delta) # Проводим первый t-test на уровне значимости a1
        
        p2 <- test_res_2$p.value
        H0_rejected_2 = ifelse(p2 < a2, 1, 0)
    
    # Если в первом тесте отвергли H0, второй тест не делаем

    } else {
        p2 <- NA
        H0_rejected_2 <- NA
    }
    
    tibble(p1,
           H0_rejected_1,
           p2,
           H0_rejected_2)
    
}

```

## Проведём 10000 исследований


Не будем применять поправок

```{r}


N <- 10000

lapply(1:N, function(i) two_experiments(
    n = 45, 
    m1 = 20, sd1 = 5, 
    m2 = 20, sd2 = 5,
    delta = 0,
    a1 = 0.05, 
    a2 = 0.05)) %>% bind_rows() -> series_results_2

series_results_2 %>% head()

# Сколько раз отвергли H0 при первых сравнениях?

series_results_2$H0_rejected_1 %>% sum() / N

# Сколько раз отвергли H0 при вторых сравнениях?

series_results_2$H0_rejected_2 %>% sum(na.rm = T) / N

```


Применим поправку Бонферрони

```{r}


N <- 10000

lapply(1:N, function(i) two_experiments(
    n = 45, 
    m1 = 20, sd1 = 5, 
    m2 = 20, sd2 = 5,
    delta = 0,
    a1 = 0.025, 
    a2 = 0.025)) %>% bind_rows() -> series_results_2

series_results_2 %>% head()

# Сколько раз отвергли H0 при первых сравнениях?

series_results_2$H0_rejected_1 %>% sum() / N

# Сколько раз отвергли H0 при вторых сравнениях?

series_results_2$H0_rejected_2 %>% sum(na.rm = T) / N

0.0262 + 0.0174

```

А теперь давайте посчитаем другие а1 и а2.

```{r}

getDesignGroupSequential(typeOfDesign = "P",
                         alpha = 0.05,
                         beta = 0.2,
                         informationRates = c(0.5, 1))
```

```{r}

lapply(1:N, function(i) two_experiments(
    n = 45, 
    m1 = 20, sd1 = 5, 
    m2 = 20, sd2 = 5,
    delta = 0,
    a1 = 0.0304, 
    a2 = 0.0304)) %>% bind_rows() -> series_results_3

series_results_3 %>% head()

# Сколько раз отвергли H0 при первых сравнениях?

series_results_3$H0_rejected_1 %>% sum() / N

# Сколько раз отвергли H0 при вторых сравнениях?

series_results_3$H0_rejected_2 %>% sum(na.rm = T) / N

```


## Задача на последовательный дизайн

Исследование превосходства препарата T в сравнении с препаратом R в лечении гиперлипидемии. Первичный показатель эффективности – доля пациентов, достигших целевых значений ЛПНП к 3 месяцу терапии. Границу превосходства спонсор предложил установить равной 5%. Ожидается, что препарат T будет эффективнее препарата R на 15%-30%, при этом точной оценки спонсор дать не может. Для препарата R из литературных данных известно, что доля пациентов, достигающих целевых значений ЛПНП к 3 месяцу терапии, составляет 56%. 
Спонсор предлагает запланировать исследование с групповым последовательным дизайном и одним промежуточным анализом. Изначально исследование предлагается спланировать для ожидаемой разницы эффективности препаратов в 15%, но, когда будет набрано 50% наблюдений, планируется проведение промежуточного анализа, на котором исследование может быть остановлено из-за доказательства гипотезы превосходства. 

### Обычный дизайн

```{r}

# Если считать по "обычному" сценарию для эффективности в 15%

epi.sssupb(
    treat = 0.71,
    control = 0.56,
    delta = 0.05,
    alpha = 0.0147,
    power = 0.8,
    r = 1,
    n = NA
)

```

Всего нужно не менее 712 пациентов, если планировать исследование для эффективности в "15%".


### Групповой последовательный дизайн

```{r}


design <- getDesignGroupSequential(typeOfDesign = "P",
                                   alpha = 0.025,
                                   beta = 0.2,
                                   informationRates = c(0.5, 1))

getSampleSizeRates(design, thetaH0 = 0.05, pi1 = 0.71, pi2 = 0.56) %>% 
    summary()


```

Всего нужно не менее 800 пациентов, но есть шанс закончить исследование раньше 
(после набора 400 человек), с учётом того, что 15% - это минимальная оценка 
эффективности препарата.

